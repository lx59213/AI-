<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ™ºèƒ½åˆ¶è¯¾ç”»å¸ƒ - æ— é™ç”»å¸ƒåŸå‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow: hidden;
        }

        .container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        /* çŠ¶æ€ä¸€ï¼šä»»åŠ¡æŒ‡ä»¤ç•Œé¢ */
        .mission-briefing {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: all 0.8s ease;
        }

        .mission-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            padding: 50px;
            max-width: 800px;
            width: 90%;
            text-align: center;
        }

        .mission-title {
            font-size: 2.2rem;
            margin-bottom: 15px;
            color: #2d3748;
            font-weight: 700;
        }

        .mission-subtitle {
            font-size: 1.1rem;
            color: #718096;
            margin-bottom: 40px;
        }

        .instruction-input {
            width: 100%;
            height: 120px;
            padding: 20px;
            border: 2px dashed #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            resize: vertical;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .instruction-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .upload-zone {
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-zone:hover {
            border-color: #667eea;
            background-color: #f7fafc;
        }

        .upload-icon {
            font-size: 2.5rem;
            color: #a0aec0;
            margin-bottom: 10px;
        }

        .upload-text {
            color: #718096;
            margin-bottom: 5px;
        }

        .file-list {
            margin-top: 15px;
            text-align: left;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: #f7fafc;
            border-radius: 6px;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .generate-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px 50px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            opacity: 0.5;
            pointer-events: none;
        }

        .generate-btn.active {
            opacity: 1;
            pointer-events: auto;
        }

        .generate-btn:hover.active {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        /* çŠ¶æ€äºŒï¼šç”»å¸ƒå·¥ä½œåŒº */
        .canvas-workspace {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f8fafc;
            display: none;
            overflow: hidden;
        }

        .canvas-container {
            position: relative;
            width: 100%;
            height: 100%;
            cursor: grab;
        }

        .canvas-container.dragging {
            cursor: grabbing;
        }

        .canvas {
            position: absolute;
            width: 5000px;
            height: 5000px;
            background-image: 
                radial-gradient(circle, #e2e8f0 1px, transparent 1px);
            background-size: 50px 50px;
            background-position: 0 0;
            transform-origin: 0 0;
            transition: transform 0.3s ease;
        }

        /* ç”»å¸ƒå·¥å…·æ  */
        .canvas-toolbar {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 10px;
            display: flex;
            gap: 8px;
            z-index: 100;
        }

        .tool-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: #f7fafc;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .tool-btn:hover {
            background: #e2e8f0;
            transform: scale(1.05);
        }

        .tool-btn.active {
            background: #667eea;
            color: white;
        }

        /* èŠ‚ç‚¹æ ·å¼ */
        .node {
            position: absolute;
            border-radius: 12px;
            background: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-weight: 600;
            border: 2px solid transparent;
        }

        .node:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .node.selected {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .node.dragging {
            transform: scale(1.1);
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        /* æ ¹èŠ‚ç‚¹ */
        .node.root {
            width: 280px;
            height: 120px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 18px;
            font-weight: 700;
        }

        /* ç« èŠ‚èŠ‚ç‚¹ */
        .node.chapter {
            width: 200px;
            height: 80px;
            background: #e6fffa;
            color: #234e52;
            font-size: 14px;
            border-left: 4px solid #38b2ac;
        }

        /* çŸ¥è¯†ç‚¹èŠ‚ç‚¹ */
        .node.topic {
            width: 160px;
            height: 60px;
            background: #fff5f5;
            color: #742a2a;
            font-size: 12px;
            border-left: 4px solid #f56565;
        }

        /* ç´ æèŠ‚ç‚¹ */
        .asset-node {
            position: absolute;
            width: 24px;
            height: 24px;
            background: #ffd700;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* è¿æ¥çº¿ */
        .connection {
            position: absolute;
            pointer-events: none;
            z-index: -1;
        }

        .connection-line {
            stroke: #cbd5e0;
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
        }

        /* AIå·¥å…·ç®± */
        .ai-toolbox {
            position: absolute;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            padding: 20px;
            width: 320px;
            z-index: 200;
            border: 1px solid #e2e8f0;
            display: none;
        }

        .toolbox-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2d3748;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }

        .quick-action-btn {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            background: #f7fafc;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .quick-action-btn:hover {
            background: #e2e8f0;
            border-color: #cbd5e0;
        }

        .micro-chat {
            border-top: 1px solid #e2e8f0;
            padding-top: 15px;
        }

        .chat-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            resize: none;
            margin-bottom: 10px;
        }

        .chat-send-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        /* ä¸Šä¸‹æ–‡èœå• */
        .context-menu {
            position: absolute;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 8px 0;
            min-width: 150px;
            z-index: 300;
            display: none;
        }

        .context-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s ease;
        }

        .context-menu-item:hover {
            background: #f7fafc;
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes nodeGrow {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .node.growing {
            animation: nodeGrow 0.6s ease-out;
        }

        @keyframes connectionDraw {
            0% {
                stroke-dasharray: 1000;
                stroke-dashoffset: 1000;
            }
            100% {
                stroke-dasharray: 1000;
                stroke-dashoffset: 0;
            }
        }

        .connection-line.drawing {
            animation: connectionDraw 0.8s ease-out;
        }

        /* éšè—æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            display: none;
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .mission-card {
                padding: 30px 20px;
            }
            
            .canvas-toolbar {
                top: 10px;
                right: 10px;
                padding: 8px;
            }
            
            .ai-toolbox {
                width: 280px;
                padding: 15px;
            }
        }

        /* å·¥å…·æç¤º */
        .tooltip {
            position: absolute;
            background: #2d3748;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .tooltip.show {
            opacity: 1;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(248, 250, 252, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 500;
            display: none;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            font-size: 16px;
            color: #4a5568;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- çŠ¶æ€ä¸€ï¼šä»»åŠ¡æŒ‡ä»¤ç•Œé¢ -->
        <div id="mission-briefing" class="mission-briefing">
            <div class="mission-card">
                <h1 class="mission-title">ğŸ¨ AIæ™ºèƒ½åˆ¶è¯¾ç”»å¸ƒ</h1>
                <p class="mission-subtitle">æè¿°æ‚¨çš„åŸ¹è®­ç›®æ ‡ï¼ŒAIå°†åœ¨ç”»å¸ƒä¸Šç”Ÿé•¿å‡ºå®Œæ•´çš„è¯¾ç¨‹çŸ¥è¯†å›¾è°±</p>
                
                <textarea 
                    id="instruction-input" 
                    class="instruction-input" 
                    placeholder="ä¸ºæ–°å…¥èŒçš„äº§å“ç»ç†ï¼Œåˆ¶ä½œä¸€é—¨å…³äºå›¢é˜Ÿç®¡ç†çš„åŸ¹è®­è¯¾ç¨‹ï¼ŒåŒ…å«æ²Ÿé€šæŠ€å·§ã€é¡¹ç›®ç®¡ç†ã€å›¢é˜Ÿæ¿€åŠ±ç­‰æ ¸å¿ƒå†…å®¹ï¼Œæ—¶é•¿90åˆ†é’Ÿã€‚"
                ></textarea>

                <div class="upload-zone" id="upload-zone">
                    <div class="upload-icon">ğŸ“</div>
                    <div class="upload-text">æ‹–æ‹½ç´ ææ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šä¼ </div>
                    <div class="upload-text" style="font-size: 14px; color: #a0aec0;">æ”¯æŒ PPT, PDF, DOCX, TXT æ ¼å¼</div>
                    <input type="file" id="file-input" multiple accept=".ppt,.pptx,.pdf,.docx,.txt" style="display: none;">
                </div>

                <div id="file-list" class="file-list"></div>

                <button id="generate-canvas-btn" class="generate-btn">ğŸš€ åœ¨ç”»å¸ƒä¸Šç”Ÿæˆè¯¾ç¨‹</button>
            </div>
        </div>

        <!-- çŠ¶æ€äºŒï¼šç”»å¸ƒå·¥ä½œåŒº -->
        <div id="canvas-workspace" class="canvas-workspace">
            <!-- ç”»å¸ƒå·¥å…·æ  -->
            <div class="canvas-toolbar">
                <button class="tool-btn" id="pan-tool" title="å¹³ç§»">âœ‹</button>
                <button class="tool-btn" id="zoom-in" title="æ”¾å¤§">ğŸ”+</button>
                <button class="tool-btn" id="zoom-out" title="ç¼©å°">ğŸ”-</button>
                <button class="tool-btn" id="fit-screen" title="é€‚åº”å±å¹•">ğŸ“</button>
                <button class="tool-btn" id="export-btn" title="å¯¼å‡º">ğŸ’¾</button>
            </div>

            <!-- ç”»å¸ƒå®¹å™¨ -->
            <div id="canvas-container" class="canvas-container">
                <div id="canvas" class="canvas">
                    <!-- SVG for connections -->
                    <svg id="connections-svg" width="5000" height="5000" style="position: absolute; top: 0; left: 0; pointer-events: none;">
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                                    refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#cbd5e0" />
                            </marker>
                        </defs>
                    </svg>
                    <!-- èŠ‚ç‚¹å°†åŠ¨æ€æ’å…¥åˆ°è¿™é‡Œ -->
                </div>
            </div>

            <!-- åŠ è½½åŠ¨ç”» -->
            <div id="loading-overlay" class="loading-overlay">
                <div style="text-align: center;">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">AIæ­£åœ¨ç”»å¸ƒä¸Šç”Ÿæˆè¯¾ç¨‹ç»“æ„...</div>
                </div>
            </div>
        </div>

        <!-- AIå·¥å…·ç®± -->
        <div id="ai-toolbox" class="ai-toolbox">
            <div class="toolbox-title">ğŸ¤– AIååŒå·¥å…·</div>
            <div class="quick-actions">
                <button class="quick-action-btn" onclick="quickAction('expand')">ğŸ“ æ‰©å†™å†…å®¹</button>
                <button class="quick-action-btn" onclick="quickAction('simplify')">âœ‚ï¸ ç²¾ç®€å†…å®¹</button>
                <button class="quick-action-btn" onclick="quickAction('quiz')">â“ ç”Ÿæˆæµ‹éªŒ</button>
                <button class="quick-action-btn" onclick="quickAction('case')">ğŸ“š æ·»åŠ æ¡ˆä¾‹</button>
            </div>
            <div class="micro-chat">
                <textarea id="chat-input" class="chat-input" placeholder="å¯¹æœ¬èŠ‚æœ‰ä»€ä¹ˆå…·ä½“è¦æ±‚ï¼Ÿ" rows="2"></textarea>
                <button class="chat-send-btn" onclick="sendChatMessage()">å‘é€</button>
            </div>
        </div>

        <!-- ä¸Šä¸‹æ–‡èœå• -->
        <div id="context-menu" class="context-menu">
            <div class="context-menu-item" onclick="contextAction('delete')">ğŸ—‘ï¸ åˆ é™¤èŠ‚ç‚¹</div>
            <div class="context-menu-item" onclick="contextAction('duplicate')">ğŸ“‹ å¤åˆ¶èŠ‚ç‚¹</div>
            <div class="context-menu-item" onclick="contextAction('addChild')">â• æ·»åŠ å­èŠ‚ç‚¹</div>
            <div class="context-menu-item" onclick="contextAction('edit')">âœï¸ ç¼–è¾‘æ ‡é¢˜</div>
        </div>

        <!-- å·¥å…·æç¤º -->
        <div id="tooltip" class="tooltip"></div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€ç®¡ç†
        let currentState = 'briefing';
        let uploadedFiles = [];
        let canvas = null;
        let canvasContainer = null;
        let nodes = [];
        let connections = [];
        let selectedNode = null;
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let canvasTransform = { x: 0, y: 0, scale: 1 };
        let isCanvasDragging = false;
        let canvasDragStart = { x: 0, y: 0 };

        // è¯¾ç¨‹æ•°æ®æ¨¡æ¿
        const courseData = {
            title: "äº§å“ç»ç†å›¢é˜Ÿç®¡ç†åŸ¹è®­",
            chapters: [
                {
                    title: "ç¬¬ä¸€ç« ï¼šç®¡ç†è®¤çŸ¥è½¬å˜",
                    topics: [
                        "1.1 ä»ä¸ªäººè´¡çŒ®è€…åˆ°ç®¡ç†è€…",
                        "1.2 ç®¡ç†è€…çš„æ ¸å¿ƒèŒè´£",
                        "1.3 å¸¸è§ç®¡ç†è¯¯åŒº"
                    ]
                },
                {
                    title: "ç¬¬äºŒç« ï¼šé«˜æ•ˆæ²Ÿé€šæŠ€å·§",
                    topics: [
                        "2.1 å€¾å¬çš„è‰ºæœ¯",
                        "2.2 åé¦ˆä¸æ‰¹è¯„æŠ€å·§",
                        "2.3 è·¨éƒ¨é—¨æ²Ÿé€šç­–ç•¥"
                    ]
                },
                {
                    title: "ç¬¬ä¸‰ç« ï¼šé¡¹ç›®ç®¡ç†å®è·µ",
                    topics: [
                        "3.1 æ•æ·é¡¹ç›®ç®¡ç†",
                        "3.2 é£é™©è¯†åˆ«ä¸æ§åˆ¶",
                        "3.3 é‡Œç¨‹ç¢‘ç®¡ç†"
                    ]
                },
                {
                    title: "ç¬¬å››ç« ï¼šå›¢é˜Ÿæ¿€åŠ±ä¸å‘å±•",
                    topics: [
                        "4.1 æ¿€åŠ±ç†è®ºåº”ç”¨",
                        "4.2 å‘˜å·¥å‘å±•è§„åˆ’",
                        "4.3 å›¢é˜Ÿæ–‡åŒ–å»ºè®¾"
                    ]
                }
            ]
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            canvas = document.getElementById('canvas');
            canvasContainer = document.getElementById('canvas-container');
        });

        function initializeEventListeners() {
            // æ–‡ä»¶ä¸Šä¼ 
            const uploadZone = document.getElementById('upload-zone');
            const fileInput = document.getElementById('file-input');
            const instructionInput = document.getElementById('instruction-input');
            const generateBtn = document.getElementById('generate-canvas-btn');

            uploadZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelect);
            uploadZone.addEventListener('dragover', handleDragOver);
            uploadZone.addEventListener('drop', handleFileDrop);
            instructionInput.addEventListener('input', checkFormValidity);
            generateBtn.addEventListener('click', generateCanvas);

            // ç”»å¸ƒå·¥å…·æ 
            document.getElementById('pan-tool').addEventListener('click', () => setTool('pan'));
            document.getElementById('zoom-in').addEventListener('click', () => zoomCanvas(1.2));
            document.getElementById('zoom-out').addEventListener('click', () => zoomCanvas(0.8));
            document.getElementById('fit-screen').addEventListener('click', fitToScreen);
            document.getElementById('export-btn').addEventListener('click', exportCanvas);

            // ç”»å¸ƒäº¤äº’
            canvasContainer.addEventListener('mousedown', handleCanvasMouseDown);
            canvasContainer.addEventListener('mousemove', handleCanvasMouseMove);
            canvasContainer.addEventListener('mouseup', handleCanvasMouseUp);
            canvasContainer.addEventListener('wheel', handleCanvasWheel);

            // å…¨å±€äº‹ä»¶
            document.addEventListener('click', handleGlobalClick);
            document.addEventListener('contextmenu', handleContextMenu);
            document.addEventListener('keydown', handleKeyDown);
        }

        // æ–‡ä»¶å¤„ç†
        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            addFiles(files);
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleFileDrop(e) {
            e.preventDefault();
            const files = Array.from(e.dataTransfer.files);
            addFiles(files);
        }

        function addFiles(files) {
            files.forEach(file => {
                if (isValidFileType(file)) {
                    uploadedFiles.push({
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        id: Date.now() + Math.random()
                    });
                }
            });
            renderFileList();
            checkFormValidity();
        }

        function isValidFileType(file) {
            return file.name.match(/\.(pdf|ppt|pptx|doc|docx|txt)$/i);
        }

        function renderFileList() {
            const fileList = document.getElementById('file-list');
            fileList.innerHTML = uploadedFiles.map(file => `
                <div class="file-item">
                    <span>${getFileIcon(file.name)} ${file.name}</span>
                    <span style="cursor: pointer;" onclick="removeFile('${file.id}')">ğŸ—‘ï¸</span>
                </div>
            `).join('');
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = { 'pdf': 'ğŸ“„', 'ppt': 'ğŸ“Š', 'pptx': 'ğŸ“Š', 'doc': 'ğŸ“', 'docx': 'ğŸ“', 'txt': 'ğŸ“ƒ' };
            return icons[ext] || 'ğŸ“';
        }

        function removeFile(fileId) {
            uploadedFiles = uploadedFiles.filter(file => file.id !== fileId);
            renderFileList();
            checkFormValidity();
        }

        function checkFormValidity() {
            const instruction = document.getElementById('instruction-input').value.trim();
            const generateBtn = document.getElementById('generate-canvas-btn');
            
            if (instruction || uploadedFiles.length > 0) {
                generateBtn.classList.add('active');
            } else {
                generateBtn.classList.remove('active');
            }
        }

        // ç”Ÿæˆç”»å¸ƒ
        function generateCanvas() {
            if (!document.getElementById('generate-canvas-btn').classList.contains('active')) {
                return;
            }

            // åˆ‡æ¢åˆ°ç”»å¸ƒçŠ¶æ€
            document.getElementById('mission-briefing').style.display = 'none';
            document.getElementById('canvas-workspace').style.display = 'block';
            document.getElementById('loading-overlay').style.display = 'flex';

            // æ¨¡æ‹Ÿç”Ÿæˆè¿‡ç¨‹
            setTimeout(() => {
                document.getElementById('loading-overlay').style.display = 'none';
                createCourseNodes();
            }, 2000);

            currentState = 'canvas';
        }

        // åˆ›å»ºè¯¾ç¨‹èŠ‚ç‚¹
        function createCourseNodes() {
            nodes = [];
            connections = [];

            // åˆ›å»ºæ ¹èŠ‚ç‚¹
            const rootNode = createNode('root', courseData.title, 2500, 2000, {
                width: 280,
                height: 120
            });
            nodes.push(rootNode);

            let chapterY = 2200;
            const chapterSpacing = 300;

            // åˆ›å»ºç« èŠ‚èŠ‚ç‚¹
            courseData.chapters.forEach((chapter, chapterIndex) => {
                const chapterX = 2200 + (chapterIndex % 2) * 600;
                const chapterNode = createNode('chapter', chapter.title, chapterX, chapterY, {
                    width: 200,
                    height: 80,
                    chapterIndex
                });
                nodes.push(chapterNode);

                // åˆ›å»ºè¿æ¥çº¿
                connections.push({
                    from: rootNode,
                    to: chapterNode
                });

                // åˆ›å»ºçŸ¥è¯†ç‚¹èŠ‚ç‚¹
                let topicY = chapterY + 150;
                chapter.topics.forEach((topic, topicIndex) => {
                    const topicX = chapterX + (topicIndex % 2 === 0 ? -100 : 100);
                    const topicNode = createNode('topic', topic, topicX, topicY, {
                        width: 160,
                        height: 60,
                        chapterIndex,
                        topicIndex
                    });
                    nodes.push(topicNode);

                    // åˆ›å»ºè¿æ¥çº¿
                    connections.push({
                        from: chapterNode,
                        to: topicNode
                    });

                    // æ·»åŠ ç´ æèŠ‚ç‚¹ï¼ˆéšæœºï¼‰
                    if (Math.random() > 0.6 && uploadedFiles.length > 0) {
                        const assetNode = createAssetNode(topicX + 80, topicY - 15, uploadedFiles[0]);
                        canvas.appendChild(assetNode);
                    }

                    topicY += 100;
                });

                chapterY += chapterSpacing;
            });

            // æ¸²æŸ“èŠ‚ç‚¹å’Œè¿æ¥çº¿
            renderNodes();
            renderConnections();
        }

        function createNode(type, title, x, y, options = {}) {
            const node = document.createElement('div');
            node.className = `node ${type} growing`;
            node.textContent = title;
            node.style.left = x + 'px';
            node.style.top = y + 'px';
            
            if (options.width) node.style.width = options.width + 'px';
            if (options.height) node.style.height = options.height + 'px';

            node.dataset.type = type;
            node.dataset.title = title;
            node.dataset.x = x;
            node.dataset.y = y;
            node.dataset.chapterIndex = options.chapterIndex || '';
            node.dataset.topicIndex = options.topicIndex || '';

            // æ·»åŠ äº‹ä»¶ç›‘å¬
            node.addEventListener('mousedown', handleNodeMouseDown);
            node.addEventListener('click', handleNodeClick);
            node.addEventListener('dblclick', handleNodeDoubleClick);

            return node;
        }

        function createAssetNode(x, y, file) {
            const assetNode = document.createElement('div');
            assetNode.className = 'asset-node';
            assetNode.textContent = getFileIcon(file.name);
            assetNode.style.left = x + 'px';
            assetNode.style.top = y + 'px';
            assetNode.title = `æ¥æº: ${file.name}`;
            return assetNode;
        }

        function renderNodes() {
            nodes.forEach((node, index) => {
                setTimeout(() => {
                    canvas.appendChild(node);
                }, index * 200);
            });
        }

        function renderConnections() {
            const svg = document.getElementById('connections-svg');
            
            connections.forEach((conn, index) => {
                setTimeout(() => {
                    const line = createConnectionLine(conn.from, conn.to);
                    svg.appendChild(line);
                }, (nodes.length + index) * 100);
            });
        }

        function createConnectionLine(fromNode, toNode) {
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            line.classList.add('connection-line', 'drawing');
            
            const fromRect = fromNode.getBoundingClientRect();
            const toRect = toNode.getBoundingClientRect();
            const canvasRect = canvas.getBoundingClientRect();
            
            const fromX = parseInt(fromNode.dataset.x) + parseInt(fromNode.style.width || 200) / 2;
            const fromY = parseInt(fromNode.dataset.y) + parseInt(fromNode.style.height || 80);
            const toX = parseInt(toNode.dataset.x) + parseInt(toNode.style.width || 160) / 2;
            const toY = parseInt(toNode.dataset.y);
            
            const midY = fromY + (toY - fromY) / 2;
            
            const d = `M ${fromX} ${fromY} Q ${fromX} ${midY} ${toX} ${toY}`;
            line.setAttribute('d', d);
            
            return line;
        }

        // èŠ‚ç‚¹äº¤äº’
        function handleNodeMouseDown(e) {
            e.stopPropagation();
            if (e.button === 0) { // å·¦é”®
                isDragging = true;
                selectedNode = e.currentTarget;
                selectedNode.classList.add('dragging');
                
                const rect = selectedNode.getBoundingClientRect();
                const canvasRect = canvas.getBoundingClientRect();
                dragOffset.x = e.clientX - rect.left;
                dragOffset.y = e.clientY - rect.top;
            }
        }

        function handleNodeClick(e) {
            e.stopPropagation();
            if (!isDragging) {
                selectNode(e.currentTarget);
                showAIToolbox(e.currentTarget);
            }
        }

        function handleNodeDoubleClick(e) {
            e.stopPropagation();
            editNodeTitle(e.currentTarget);
        }

        function selectNode(node) {
            // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
            nodes.forEach(n => n.classList.remove('selected'));
            
            // é€‰æ‹©æ–°èŠ‚ç‚¹
            node.classList.add('selected');
            selectedNode = node;
        }

        function showAIToolbox(node) {
            const toolbox = document.getElementById('ai-toolbox');
            const rect = node.getBoundingClientRect();
            
            toolbox.style.left = (rect.right + 20) + 'px';
            toolbox.style.top = rect.top + 'px';
            toolbox.style.display = 'block';
            
            // æ›´æ–°å·¥å…·ç®±æ ‡é¢˜
            const title = toolbox.querySelector('.toolbox-title');
            title.textContent = `ğŸ¤– ${node.dataset.title}`;
        }

        function editNodeTitle(node) {
            const currentTitle = node.textContent;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentTitle;
            input.style.cssText = `
                width: 100%;
                height: 100%;
                border: none;
                background: transparent;
                text-align: center;
                font-weight: 600;
                font-size: inherit;
                color: inherit;
            `;
            
            node.innerHTML = '';
            node.appendChild(input);
            input.focus();
            input.select();
            
            const finishEdit = () => {
                const newTitle = input.value.trim() || currentTitle;
                node.textContent = newTitle;
                node.dataset.title = newTitle;
            };
            
            input.addEventListener('blur', finishEdit);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    finishEdit();
                } else if (e.key === 'Escape') {
                    node.textContent = currentTitle;
                }
            });
        }

        // ç”»å¸ƒäº¤äº’
        function handleCanvasMouseDown(e) {
            if (e.target === canvasContainer || e.target === canvas) {
                isCanvasDragging = true;
                canvasContainer.classList.add('dragging');
                canvasDragStart.x = e.clientX - canvasTransform.x;
                canvasDragStart.y = e.clientY - canvasTransform.y;
                
                // éšè—AIå·¥å…·ç®±
                document.getElementById('ai-toolbox').style.display = 'none';
            }
        }

        function handleCanvasMouseMove(e) {
            if (isDragging && selectedNode) {
                // æ‹–æ‹½èŠ‚ç‚¹
                const canvasRect = canvas.getBoundingClientRect();
                const x = (e.clientX - canvasRect.left - dragOffset.x) / canvasTransform.scale;
                const y = (e.clientY - canvasRect.top - dragOffset.y) / canvasTransform.scale;
                
                selectedNode.style.left = x + 'px';
                selectedNode.style.top = y + 'px';
                selectedNode.dataset.x = x;
                selectedNode.dataset.y = y;
                
                // æ›´æ–°è¿æ¥çº¿
                updateConnections();
                
            } else if (isCanvasDragging) {
                // æ‹–æ‹½ç”»å¸ƒ
                canvasTransform.x = e.clientX - canvasDragStart.x;
                canvasTransform.y = e.clientY - canvasDragStart.y;
                updateCanvasTransform();
            }
        }

        function handleCanvasMouseUp(e) {
            if (isDragging) {
                isDragging = false;
                if (selectedNode) {
                    selectedNode.classList.remove('dragging');
                }
            }
            
            if (isCanvasDragging) {
                isCanvasDragging = false;
                canvasContainer.classList.remove('dragging');
            }
        }

        function handleCanvasWheel(e) {
            e.preventDefault();
            const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
            zoomCanvas(zoomFactor, e.clientX, e.clientY);
        }

        function zoomCanvas(factor, centerX, centerY) {
            const oldScale = canvasTransform.scale;
            canvasTransform.scale = Math.max(0.1, Math.min(3, canvasTransform.scale * factor));
            
            if (centerX && centerY) {
                const scaleChange = canvasTransform.scale - oldScale;
                canvasTransform.x -= (centerX - canvasTransform.x) * scaleChange / oldScale;
                canvasTransform.y -= (centerY - canvasTransform.y) * scaleChange / oldScale;
            }
            
            updateCanvasTransform();
        }

        function updateCanvasTransform() {
            canvas.style.transform = `translate(${canvasTransform.x}px, ${canvasTransform.y}px) scale(${canvasTransform.scale})`;
        }

        function fitToScreen() {
            if (nodes.length === 0) return;
            
            // è®¡ç®—æ‰€æœ‰èŠ‚ç‚¹çš„è¾¹ç•Œ
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            
            nodes.forEach(node => {
                const x = parseInt(node.dataset.x);
                const y = parseInt(node.dataset.y);
                const width = parseInt(node.style.width || 200);
                const height = parseInt(node.style.height || 80);
                
                minX = Math.min(minX, x);
                minY = Math.min(minY, y);
                maxX = Math.max(maxX, x + width);
                maxY = Math.max(maxY, y + height);
            });
            
            const contentWidth = maxX - minX;
            const contentHeight = maxY - minY;
            const containerWidth = canvasContainer.clientWidth;
            const containerHeight = canvasContainer.clientHeight;
            
            const scaleX = (containerWidth - 100) / contentWidth;
            const scaleY = (containerHeight - 100) / contentHeight;
            canvasTransform.scale = Math.min(scaleX, scaleY, 1);
            
            canvasTransform.x = (containerWidth - contentWidth * canvasTransform.scale) / 2 - minX * canvasTransform.scale;
            canvasTransform.y = (containerHeight - contentHeight * canvasTransform.scale) / 2 - minY * canvasTransform.scale;
            
            updateCanvasTransform();
        }

        function updateConnections() {
            const svg = document.getElementById('connections-svg');
            svg.innerHTML = `
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                            refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#cbd5e0" />
                    </marker>
                </defs>
            `;
            
            connections.forEach(conn => {
                const line = createConnectionLine(conn.from, conn.to);
                svg.appendChild(line);
            });
        }

        // AIå·¥å…·ç®±åŠŸèƒ½
        function quickAction(action) {
            if (!selectedNode) return;
            
            const actions = {
                'expand': 'æ­£åœ¨ä¸ºè¯¥èŠ‚ç‚¹æ‰©å†™è¯¦ç»†å†…å®¹...',
                'simplify': 'æ­£åœ¨ç²¾ç®€è¯¥èŠ‚ç‚¹å†…å®¹...',
                'quiz': 'æ­£åœ¨ç”Ÿæˆç›¸å…³æµ‹éªŒé¢˜ç›®...',
                'case': 'æ­£åœ¨ä»ç´ æåº“æŸ¥æ‰¾ç›¸å…³æ¡ˆä¾‹...'
            };
            
            showTooltip(actions[action], selectedNode);
            
            // æ¨¡æ‹ŸAIå¤„ç†
            setTimeout(() => {
                if (action === 'expand') {
                    // æ·»åŠ å­èŠ‚ç‚¹ç¤ºä¾‹
                    addChildNode(selectedNode, 'è¯¦ç»†å†…å®¹ç‚¹');
                } else if (action === 'quiz') {
                    alert('å·²ä¸ºè¯¥èŠ‚ç‚¹ç”Ÿæˆ3é“æµ‹éªŒé¢˜ç›®ï¼');
                }
            }, 1500);
        }

        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message || !selectedNode) return;
            
            showTooltip(`AIæ­£åœ¨å¤„ç†: ${message}`, selectedNode);
            input.value = '';
            
            // æ¨¡æ‹ŸAIå“åº”
            setTimeout(() => {
                showTooltip('å†…å®¹å·²æ›´æ–°ï¼Œè¯·æŸ¥çœ‹èŠ‚ç‚¹å˜åŒ–', selectedNode);
            }, 1500);
        }

        function addChildNode(parentNode, title) {
            const parentX = parseInt(parentNode.dataset.x);
            const parentY = parseInt(parentNode.dataset.y);
            const parentHeight = parseInt(parentNode.style.height || 80);
            
            const childNode = createNode('topic', title, parentX + 50, parentY + parentHeight + 50, {
                width: 160,
                height: 60
            });
            
            nodes.push(childNode);
            canvas.appendChild(childNode);
            
            connections.push({
                from: parentNode,
                to: childNode
            });
            
            updateConnections();
        }

        // ä¸Šä¸‹æ–‡èœå•
        function handleContextMenu(e) {
            if (e.target.classList.contains('node')) {
                e.preventDefault();
                selectedNode = e.target;
                showContextMenu(e.clientX, e.clientY);
            }
        }

        function showContextMenu(x, y) {
            const menu = document.getElementById('context-menu');
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.style.display = 'block';
        }

        function contextAction(action) {
            document.getElementById('context-menu').style.display = 'none';
            
            if (!selectedNode) return;
            
            switch (action) {
                case 'delete':
                    deleteNode(selectedNode);
                    break;
                case 'duplicate':
                    duplicateNode(selectedNode);
                    break;
                case 'addChild':
                    addChildNode(selectedNode, 'æ–°å­èŠ‚ç‚¹');
                    break;
                case 'edit':
                    editNodeTitle(selectedNode);
                    break;
            }
        }

        function deleteNode(node) {
            if (node.dataset.type === 'root') {
                alert('ä¸èƒ½åˆ é™¤æ ¹èŠ‚ç‚¹ï¼');
                return;
            }
            
            // ç§»é™¤èŠ‚ç‚¹
            const index = nodes.indexOf(node);
            if (index > -1) {
                nodes.splice(index, 1);
            }
            
            // ç§»é™¤ç›¸å…³è¿æ¥
            connections = connections.filter(conn => 
                conn.from !== node && conn.to !== node
            );
            
            node.remove();
            updateConnections();
            
            document.getElementById('ai-toolbox').style.display = 'none';
        }

        function duplicateNode(node) {
            const newNode = createNode(
                node.dataset.type,
                node.dataset.title + ' (å‰¯æœ¬)',
                parseInt(node.dataset.x) + 50,
                parseInt(node.dataset.y) + 50,
                {
                    width: parseInt(node.style.width),
                    height: parseInt(node.style.height)
                }
            );
            
            nodes.push(newNode);
            canvas.appendChild(newNode);
        }

        // å…¨å±€äº‹ä»¶å¤„ç†
        function handleGlobalClick(e) {
            if (!e.target.closest('.ai-toolbox') && !e.target.classList.contains('node')) {
                document.getElementById('ai-toolbox').style.display = 'none';
            }
            
            if (!e.target.closest('.context-menu')) {
                document.getElementById('context-menu').style.display = 'none';
            }
        }

        function handleKeyDown(e) {
            if (e.key === 'Delete' && selectedNode) {
                deleteNode(selectedNode);
            } else if (e.key === 'Escape') {
                document.getElementById('ai-toolbox').style.display = 'none';
                document.getElementById('context-menu').style.display = 'none';
            }
        }

        // å·¥å…·å‡½æ•°
        function showTooltip(text, targetElement) {
            const tooltip = document.getElementById('tooltip');
            const rect = targetElement.getBoundingClientRect();
            
            tooltip.textContent = text;
            tooltip.style.left = rect.right + 10 + 'px';
            tooltip.style.top = rect.top + 'px';
            tooltip.classList.add('show');
            
            setTimeout(() => {
                tooltip.classList.remove('show');
            }, 3000);
        }

        function setTool(tool) {
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tool + '-tool').classList.add('active');
        }

        function exportCanvas() {
            alert('ç”»å¸ƒå¯¼å‡ºåŠŸèƒ½ï¼šå¯å¯¼å‡ºä¸ºPNGå›¾ç‰‡ã€PDFæ–‡æ¡£æˆ–JSONæ•°æ®æ ¼å¼ã€‚\n\nï¼ˆæ¼”ç¤ºç‰ˆæœ¬æš‚ä¸æ”¯æŒå®é™…å¯¼å‡ºï¼‰');
        }

        // åˆå§‹åŒ–æ¼”ç¤ºæ•°æ®
        setTimeout(() => {
            // é¢„å¡«å……æ¼”ç¤ºæŒ‡ä»¤
            document.getElementById('instruction-input').value = 'ä¸ºæ–°å…¥èŒçš„äº§å“ç»ç†ï¼Œåˆ¶ä½œä¸€é—¨å…³äºå›¢é˜Ÿç®¡ç†çš„åŸ¹è®­è¯¾ç¨‹ï¼ŒåŒ…å«æ²Ÿé€šæŠ€å·§ã€é¡¹ç›®ç®¡ç†ã€å›¢é˜Ÿæ¿€åŠ±ç­‰æ ¸å¿ƒå†…å®¹ï¼Œæ—¶é•¿90åˆ†é’Ÿã€‚';
            
            // æ·»åŠ æ¼”ç¤ºæ–‡ä»¶
            uploadedFiles = [
                { id: 'demo1', name: 'å›¢é˜Ÿç®¡ç†æ‰‹å†Œ.pdf', size: 2048000, type: 'application/pdf' },
                { id: 'demo2', name: 'é¡¹ç›®ç®¡ç†æ¨¡æ¿.pptx', size: 1536000, type: 'application/vnd.openxmlformats-officedocument.presentationml.presentation' }
            ];
            
            renderFileList();
            checkFormValidity();
        }, 500);
    </script>
</body>
</html>