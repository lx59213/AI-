<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI智能制课画布 - 可追溯版</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-container">
        <!-- 状态一：任务指令界面 -->
        <div id="mission-briefing" class="mission-briefing">
            <div class="mission-card">
                <h1 class="mission-title">🎨 AI智能制课画布</h1>
                <p class="mission-subtitle">描述您的培训目标，AI将在画布上生长出完整的课程知识图谱</p>
                
                <textarea 
                    id="instruction-input" 
                    class="instruction-input" 
                    placeholder="为新入职的产品经理，制作一门关于团队管理的培训课程，包含沟通技巧、项目管理、团队激励等核心内容，时长90分钟。"
                ></textarea>

                <div class="upload-zone" id="upload-zone">
                    <div class="upload-icon">📁</div>
                    <div class="upload-text">拖拽素材文件到此处或点击上传</div>
                    <div class="upload-text" style="font-size: 14px; color: #a0aec0;">支持 PPT, PDF, DOCX, TXT, MD, 图片, 视频, 音频格式</div>
                    <input type="file" id="file-input" multiple accept=".ppt,.pptx,.pdf,.docx,.txt,.md,.jpg,.png,.mp4,.mp3" style="display: none;">
                </div>

                <div id="file-list" class="file-list"></div>

                <button id="generate-canvas-btn" class="generate-btn">🚀 在画布上生成课程</button>
            </div>
        </div>

        <!-- 状态二：画布工作区 -->
        <div id="canvas-workspace" class="canvas-workspace">
            <!-- 统一资源库面板 -->
            <div id="resource-library" class="resource-library">
                <div class="library-header">
                    <h3 class="library-title">📚 统一资源库</h3>
                    <button class="collapse-btn" id="collapse-library" title="折叠/展开">➖</button>
                </div>
                
                <div class="library-content">
                    <!-- 意图引导区 -->
                    <div class="intent-section">
                        <label class="intent-label">课程目标/大纲</label>
                        <textarea 
                            id="course-objective" 
                            class="objective-input" 
                            placeholder="为期3天的产品经理团队管理培训，重点是认知转变和项目实践。"
                            rows="3"
                        ></textarea>
                        <button id="generate-course-btn" class="generate-course-btn">🚀 生成/更新课程</button>
                    </div>
                    
                    <!-- 文件上传区 -->
                    <div class="upload-section">
                        <div class="upload-zone-compact" id="library-upload-zone">
                            <div class="upload-icon-small">📁</div>
                            <div class="upload-text-small">拖拽或点击上传素材</div>
                            <input type="file" id="library-file-input" multiple accept=".ppt,.pptx,.pdf,.docx,.txt,.md,.jpg,.png,.mp4,.mp3" style="display: none;">
                        </div>
                    </div>
                    
                    <!-- 资源列表 -->
                    <div class="resource-list" id="resource-list">
                        <!-- 资源项将动态插入到这里 -->
                    </div>
                </div>
            </div>

            <!-- 画布工具栏 -->
            <div class="canvas-toolbar">
                <button class="tool-btn" id="zoom-in" title="放大">🔍+</button>
                <button class="tool-btn" id="zoom-out" title="缩小">🔍-</button>
                <button class="tool-btn" id="fit-screen" title="适应屏幕">📐</button>
                <button class="tool-btn" id="reset-view" title="重置视图">🏠</button>
                <div class="toolbar-divider"></div>
                <button class="tool-btn primary" id="preview-course" title="预览课程">👁️</button>
                <button class="tool-btn primary" id="generate-courseware" title="整体Review">🔍</button>
            </div>

            <!-- 画布容器 -->
            <div id="canvas-container" class="canvas-container">
                <div id="canvas" class="canvas">
                    <!-- 节点将动态插入到这里 -->
                </div>
            </div>

            <!-- 加载动画 -->
            <div id="loading-overlay" class="loading-overlay">
                <div class="loading-content">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">AI正在画布上生成课程结构...</div>
                </div>
            </div>
        </div>

        <!-- 上下文菜单 -->
        <div id="context-menu" class="context-menu">
            <div class="context-menu-item" onclick="contextAction('edit')">✏️ 编辑内容</div>
            <div class="context-menu-item" onclick="contextAction('viewSource')">🔍 查看来源</div>
            <div class="context-menu-item" onclick="contextAction('addChild')">➕ 添加子节点</div>
            <div class="context-menu-item" onclick="contextAction('split')">✂️ 拆分节点</div>
            <div class="context-menu-item" onclick="contextAction('merge')">🔗 合并节点</div>
            <div class="context-menu-item" onclick="contextAction('disconnect')">🔓 断开连接</div>
            <div class="context-menu-item" onclick="contextAction('duplicate')">📋 复制节点</div>
            <div class="context-menu-item" onclick="contextAction('delete')">🗑️ 删除节点</div>
        </div>

        <!-- 提示框 -->
        <div id="tooltip" class="tooltip"></div>
        
        <!-- 来源浏览器 -->
        <div id="source-browser" class="source-browser">
            <div class="source-header">
                <h3>🔍 内容来源</h3>
                <button class="close-btn" onclick="closeSourceBrowser()">×</button>
            </div>
            <div class="source-content" id="source-content">
                <!-- 来源信息将动态插入到这里 -->
            </div>
        </div>
        
        <!-- 节点编辑器 -->
        <div id="node-editor" class="node-editor">
            <div class="editor-header">
                <h3>✏️ 编辑节点</h3>
                <button class="close-btn" onclick="closeNodeEditor()">×</button>
            </div>
            <div class="editor-content">
                <div class="editor-field">
                    <label>标题</label>
                    <input type="text" id="node-title-input" class="title-input">
                </div>
                <div class="editor-field">
                    <label>内容</label>
                    <textarea id="node-content-input" class="content-input" rows="6"></textarea>
                </div>
                <div class="editor-actions">
                    <button class="ai-action-btn" onclick="aiEnhance('expand')">📝 AI扩展</button>
                    <button class="ai-action-btn" onclick="aiEnhance('simplify')">✂️ AI精简</button>
                    <button class="ai-action-btn" onclick="aiEnhance('example')">📚 添加案例</button>
                </div>
                <div class="editor-buttons">
                    <button class="save-btn" onclick="saveNodeEdit()">保存</button>
                    <button class="cancel-btn" onclick="closeNodeEditor()">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 课程预览模态框 -->
    <div id="course-preview-modal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h2>📖 课程预览</h2>
                <button class="close-btn" onclick="closePreviewModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="course-preview-content" class="course-preview">
                    <!-- 预览内容将动态生成 -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" onclick="closePreviewModal()">返回编辑</button>
                <button class="btn primary" onclick="generateCourseware()">生成课件</button>
            </div>
        </div>
    </div>

    <!-- 课程Review模态框 -->
    <div id="review-modal" class="modal">
        <div class="modal-content extra-large">
            <div class="modal-header">
                <h2>🔍 课程整体Review</h2>
                <button class="close-btn" onclick="closeReviewModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="review-layout">
                    <div class="review-sidebar">
                        <div class="review-nav">
                            <button class="nav-item active" data-tab="structure">📋 结构检查</button>
                            <button class="nav-item" data-tab="content">📝 内容审核</button>
                            <button class="nav-item" data-tab="quality">⭐ 质量评估</button>
                            <button class="nav-item" data-tab="suggestions">💡 优化建议</button>
                        </div>
                    </div>
                    <div class="review-content">
                        <div id="review-structure" class="review-tab active">
                            <h3>📋 课程结构分析</h3>
                            <div class="structure-analysis">
                                <div class="analysis-item">
                                    <div class="item-header">
                                        <span class="status-icon success">✅</span>
                                        <strong>课程完整性</strong>
                                    </div>
                                    <p>课程包含4个主要章节，结构完整，逻辑清晰</p>
                                </div>
                                <div class="analysis-item">
                                    <div class="item-header">
                                        <span class="status-icon success">✅</span>
                                        <strong>时长分配</strong>
                                    </div>
                                    <p>总时长90分钟，各章节时长分配合理</p>
                                </div>
                                <div class="analysis-item">
                                    <div class="item-header">
                                        <span class="status-icon warning">⚠️</span>
                                        <strong>知识点密度</strong>
                                    </div>
                                    <p>第二章知识点较密集，建议适当精简或分拆</p>
                                </div>
                            </div>
                        </div>
                        <div id="review-content" class="review-tab">
                            <h3>📝 内容质量审核</h3>
                            <div class="content-review">
                                <div class="review-section">
                                    <h4>✅ 内容覆盖度</h4>
                                    <div class="coverage-chart">
                                        <div class="coverage-item">
                                            <span>理论知识</span>
                                            <div class="progress-bar mini">
                                                <div class="progress-fill" style="width: 85%"></div>
                                            </div>
                                            <span>85%</span>
                                        </div>
                                        <div class="coverage-item">
                                            <span>实践案例</span>
                                            <div class="progress-bar mini">
                                                <div class="progress-fill" style="width: 70%"></div>
                                            </div>
                                            <span>70%</span>
                                        </div>
                                        <div class="coverage-item">
                                            <span>互动环节</span>
                                            <div class="progress-bar mini">
                                                <div class="progress-fill" style="width: 60%"></div>
                                            </div>
                                            <span>60%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="review-quality" class="review-tab">
                            <h3>⭐ 质量评估报告</h3>
                            <div class="quality-metrics">
                                <div class="metric-card">
                                    <div class="metric-score">8.5</div>
                                    <div class="metric-label">整体评分</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-score">90%</div>
                                    <div class="metric-label">内容完整度</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-score">85%</div>
                                    <div class="metric-label">逻辑清晰度</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-score">75%</div>
                                    <div class="metric-label">实用性</div>
                                </div>
                            </div>
                        </div>
                        <div id="review-suggestions" class="review-tab">
                            <h3>💡 AI优化建议</h3>
                            <div class="suggestions-list">
                                <div class="suggestion-item high">
                                    <div class="suggestion-priority">高</div>
                                    <div class="suggestion-content">
                                        <strong>增加互动环节</strong>
                                        <p>建议在每章结束后添加小组讨论或案例分析，提高学员参与度</p>
                                    </div>
                                </div>
                                <div class="suggestion-item medium">
                                    <div class="suggestion-priority">中</div>
                                    <div class="suggestion-content">
                                        <strong>优化时长分配</strong>
                                        <p>第二章内容较多，建议分为两个小节，每节45分钟</p>
                                    </div>
                                </div>
                                <div class="suggestion-item low">
                                    <div class="suggestion-priority">低</div>
                                    <div class="suggestion-content">
                                        <strong>增加视觉元素</strong>
                                        <p>可以添加更多图表和示例，增强视觉效果</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" onclick="closeReviewModal()">关闭</button>
                <button class="btn primary" onclick="generateCourseware()">生成课件</button>
            </div>
        </div>
    </div>

    <!-- 脚本文件 -->
    <script src="data.js"></script>
    <script src="canvas-engine.js"></script>
    <script src="app-enhanced.js"></script>
    
    <script>
        // 简单的错误处理
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.log('Error: ' + msg + '\nURL: ' + url + '\nLine: ' + lineNo + '\nColumn: ' + columnNo + '\nError object: ' + JSON.stringify(error));
            return false;
        };
        
        // 确保DOM加载完成后再初始化
        document.addEventListener('DOMContentLoaded', function() {
            try {
                if (typeof CanvasApp !== 'undefined') {
                    window.app = new CanvasApp();
                } else {
                    console.error('CanvasApp 未定义');
                }
            } catch (error) {
                console.error('初始化应用时发生错误:', error);
            }
        });
    </script>
</body>
</html>