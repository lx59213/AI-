# 需求说明：AI制课系统-可追溯性与交互式优化 V1.0

## 1. 项目背景与目标

当前AI制课画布功能强大，但在用户与AI的协作过程中存在一定的“黑箱”问题。用户上传素材后，AI直接生成课程内容，整个过程缺乏透明度，导致用户难以追溯信息来源、验证内容准确性，也为后续的迭代修改带来了困难。这与我们在`设计原则.md`中追求的“AI必须行”理念——即AI应主动承担更多理解和处理上下文的工作，以弥合人类表达的模糊性——尚有差距。

为了解决这一痛点，并实现`版本三、无限画布需求说明.md`中提出的“知识地图”愿景，本次升级旨在**构建一个透明、可控、可追溯的“白盒式”AI制课环境。**

**核心目标**：将制课过程从单向的“生成-接收”模式，转变为双向的“**对话式共创**”模式。用户可以轻松管理多样化的源素材，而AI生成的每一条知识点都能精确溯源。最终交付的不再是静态的课程，而是一张动态的、可交互、可验证的活性知识地图，从而极大提升课程资产的价值。

## 2. 核心功能模块

### 2.1. 统一资源库（前端）

在画布界面左侧（当前红框设想区域）建立一个常驻的“统一资源库”面板。

-   **UI界面**：一个专用的、可折叠的侧边栏面板。
-   **核心功能**：
    1.  **多格式文件上传**：支持用户通过拖拽或点击上传多种格式的源文件，包括但不限于：PDF, DOCX, PPTX, MD, TXT, 以及常见的图片、音频和视频格式。
    2.  **资源管理与状态显示**：在面板中清晰地列出所有已上传的资源。每个资源项应显示：文件名、文件类型图标、以及后端处理状态（如：“上传中...”、“解析中...”、“就绪”、“失败”）。
    3.  **上下文动态控制**：为每个资源提供一个独立的启用/禁用开关（如：复选框）。用户可以随时勾选或取消，以精确控制哪些文件被纳入下一次AI生成任务的知识范畴。
    4.  **基础操作**：提供对已上传资源的管理功能，如删除。
    5.  **双向同步**：资源库与画布应实现双向同步。在资源库上传的文件，若包含图片等可视化元素，可在画布某处（如一个待处理区域）出现；反之，在画布节点上直接上传的图片或附件，也应自动登记到资源库中。

### 2.2. 意图引导与生成控制（前端/后端接口）

在“统一资源库”面板的顶部，提供一个清晰的交互区，用于指导AI的生成过程。

-   **UI界面**：一个简洁的文本输入框，标签可设为“课程目标/大纲”。
-   **核心功能**：
    1.  **高级意图输入**：允许用户输入课程的核心主题、目标受众、或一个初步的结构大纲。这为AI提供了明确的创作方向和“规范（Spec）”。
    2.  **生成触发**：一个醒目的“生成/更新课程”按钮，用于启动或基于新的上下文（修改后的资源开关、更新后的大纲）重新执行AI制课任务。

### 2.3. 可追溯内容生成（后端）

这是实现“白盒”制课的技术核心，采用**检索增强生成（RAG）**架构。

-   **核心流程**：
    1.  **统一解析与分块（Ingestion & Parsing）**：文件上传后，后端服务自动将其内容解析为标准化的文本块（Chunks）。对于非文本格式，调用相应的引擎（如OCR、ASR）提取文本内容后再分块。
    2.  **来源精确索引（Source Indexing）**：在分块的同时，为**每一个**文本块附加精确、唯一的来源元数据。例如：`{"fileId": "file_abc_123", "fileName": "产品经理的自我修养.pdf", "chunkId": "chunk_xyz_789", "page": 10, "location": "paragraph 3"}`。此元数据是实现溯源的关键。
    3.  **智能检索（Retrieval）**：当用户点击生成按钮时，系统首先根据用户在“意图引导”框中输入的内容，对所有**已启用**的资源进行语义检索，找出与目标最相关的一批文本块。
    4.  **带引用的生成（Generation with Citation）**：将检索到的文本块（及其来源元数据）作为上下文，连同用户的指令一起发送给大语言模型（LLM）。并**强制**LLM在生成每个课程节点时，必须引用其内容所依赖的文本块`chunkId`。
    5.  **结构化输出**：最终返回给前端的数据结构必须包含溯源信息。例如，一个节点的JSON对象可能如下：
        ```json
        {
          "nodeId": "1.2",
          "title": "管理者的核心职责",
          "content": "管理者需要承担计划、组织、领导和控制等关键职责...",
          "sources": ["chunk_xyz_789", "chunk_abc_456"]
        }
        ```

### 2.4. 交互式溯源（前端）

将后端返回的溯源信息在画布上以直观、便捷的方式呈现给用户。

-   **UI/UX交互**：
    1.  **溯源入口**：当用户选中或悬停在画布的任一知识节点上时，节点旁出现一个明确的“查看来源”图标。
    2.  **来源浏览器**：点击该图标，弹出一个独立的“来源浏览器”窗口或侧边栏。
    3.  **内容展示**：该浏览器内会清晰地展示该节点内容所引用的所有原始文本片段。每个片段上方都应有明确的来源标注，例如：“**来源：** `产品经理的自我修养.pdf`，第10页”。
    4.  **无缝验证**：用户可以直接对比AI生成的内容和原始材料，快速完成事实核查和准确性判断。

## 3. 知识地图的高级编辑与重构

此章节的需求源于一个核心视角：**将用户从知识内容的“审阅者”提升为知识地图的“主动共创者”**。用户必须拥有强大、灵活的编辑工具来对AI生成的初稿进行精修、重构和个性化。

### 3.1. 节点结构操作

-   **自由连接**：允许用户断开任意节点（包括层级首位的节点）与其父节点的连接，并将其拖拽链接到画布上的任何其他节点，实现课程逻辑的完全重组。
-   **手动添加/删除**：用户可以在任何位置手动添加新的空白节点或子节点，也可以随时删除任何节点（及其所有子节点）。
-   **节点拆分**：对于内容复杂或冗长的节点，提供“一键拆分”功能。例如，AI可根据内容的语义（如不同段落）自动将其拆分为多个独立的子节点。
-   **节点合并**：允许用户选中多个节点，通过“合并”操作将它们的内容和子节点汇集到一个新的或指定的父节点下。

### 3.2. 节点内容操作

-   **富文本编辑**：节点内容支持富文本编辑，包括加粗、斜体、列表、引用等，使用户能够更好地组织和呈现知识。
-   **内容再生（AI增强）**：为每个节点提供AI辅助功能：
    -   **扩展**：基于当前节点内容，让AI进行更详细的阐述或补充。
    -   **缩写**：将节点内容精炼为核心摘要。
    -   **举例**：要求AI为当前知识点生成一个或多个具体案例。
-   **格式转换**：允许用户将一个文本节点快速转换为其他形式，如“任务”、“问题”或“关键结论”，并以不同的视觉样式呈现。

### 3.3. 视图与布局

-   **多布局切换**：除了默认的思维导图布局，提供多种视图选项，如：树状图、组织结构图、时间线视图等，以适应不同类型的课程内容。
-   **自由布局模式**：提供一个“自由画布”模式，允许用户完全手动地、任意地摆放节点位置，不受自动布局算法的约束。

## 4. 典型用户流程（User Story）

1.  **启动**：用户进入制课画布，左侧是空的“统一资源库”。
2.  **取材**：用户将一份PPT、两份PDF和一份Word文档拖入资源库。系统自动开始解析，并显示各文件的“解析中...”状态，几秒后全部变为“就绪”。
3.  **立意**：用户在顶部的“课程目标”框中输入：“为期3天的产品经理团队管理培训，重点是认知转变和项目实践。”
4.  **生成**：用户点击“生成课程”按钮。
5.  **审阅与溯源**：几秒后，画布上生成了完整的课程大纲思维导图。用户对“2.2 反馈与批评技巧”这个节点的内容有些疑问，通过点击“查看来源”确认了信息出处。
6.  **结构重组**：用户认为AI生成的“第四章：团队激励与发展”应该和“第二章：高效沟通技巧”合并讲解。他直接将第四章的根节点拖拽到第二章下，使其成为一个新的子主题。
7.  **内容精修**：用户觉得“3.1 敏捷项目管理”这个节点内容过于理论，于是他选中该节点，点击“AI操作 -> 举例”，AI为其生成了两个生动的实践案例作为子节点。接着，他将另一个相关节点的内容通过拖拽合并了进来。
8.  **个性化补充**：用户在“项目管理实践”分支下手动添加了一个新节点，命名为“我们团队的复盘模板”，并直接在节点内编辑，插入了团队内部的实践文档链接。
9.  **最终确认**：经过一系列重组和精修，用户得到了一张完全符合自己教学思路的、内容可信、结构清晰的知识地图。

## 5. 预期价值

-   **信任与透明**：彻底打破AI“黑箱”，用户对生成内容的每一句话都“心中有数”，极大增强对AI协作的信任感。
-   **效率与质量**：将“猜”和“蒙”的过程，转变为“看”和“改”的过程。用户可以快速定位、验证和修正，课程研发的迭代效率和最终质量将显著提升。
-   **知识资产沉淀**：交付物不再是一份单薄的课程文件，而是一张包含完整逻辑、内容和原始依据的“活性知识地图”，成为企业内部可追溯、可演进、可复用的宝贵知识资产。
-   **专家智慧注入**：强大的编辑功能确保了领域专家的经验和智慧能够被无缝注入和沉淀到知识地图中，使最终成果远超单纯的AI内容聚合。
